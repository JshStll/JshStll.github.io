<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LoD2 Gebäude (basemap.de)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cesium@1.125/Build/Cesium/Widgets/widgets.css" />
  <style>
    html, body, #cesiumContainer { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; }
    #status { position: absolute; left: 10px; top: 10px; z-index: 2; background: rgba(255,255,255,0.92); color: #111; padding: 0.35rem 0.6rem; border-radius: 6px; font-size: 0.95rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <div id="status">Initialisiere...</div>
  <script>window.CESIUM_BASE_URL = 'https://cdn.jsdelivr.net/npm/cesium@1.125/Build/Cesium';</script>
  <script src="https://cdn.jsdelivr.net/npm/cesium@1.125/Build/Cesium/Cesium.js"></script>
  <script>
    (function(){
      const setStatus = (s) => { const el = document.getElementById('status'); if(el) el.textContent = s; console.log('[LoD2]', s); };
      setStatus('Erstelle Cesium Viewer…');

      // Create viewer
      const viewer = new Cesium.Viewer('cesiumContainer', {
        shadows: false,
        geocoder: false,
        baseLayerPicker: false,
        animation: true,
        timeline: true
      });

      // Add OSM as fallback imagery
      const osm = new Cesium.OpenStreetMapImageryProvider({ url: 'https://a.tile.openstreetmap.org/' });
      viewer.imageryLayers.addImageryProvider(osm);

      // Add basemap.de WMS (where available)
      const wms = new Cesium.WebMapServiceImageryProvider({
        url: 'https://sgx.geodatenzentrum.de/wms_basemapde',
        layers: 'de_basemapde_web_raster_farbe',
        parameters: { transparent: true, format: 'image/png' }
      });
      viewer.imageryLayers.addImageryProvider(wms);

      // Start camera roughly over Hochschule Mainz
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(8.2272952, 49.9884830, 800.0),
        orientation: { heading: Cesium.Math.toRadians(0.0), pitch: Cesium.Math.toRadians(-50.0), roll: 0.0 }
      });

      // Tileset URL (basemap.de LoD2 sample)
      const tilesetUrl = 'https://sgx.geodatenzentrum.de/gdz_basemapde_3d_gebaeude/lod2_4978_null.json';

      async function loadTileset(){
        setStatus('Lade LoD2 Tileset…');
        try {
          let tileset;
          if (Cesium.Cesium3DTileset && typeof Cesium.Cesium3DTileset.fromUrl === 'function'){
            tileset = await Cesium.Cesium3DTileset.fromUrl(tilesetUrl, { showOutline: false });
          } else {
            tileset = new Cesium.Cesium3DTileset({ url: tilesetUrl });
          }
          viewer.scene.primitives.add(tileset);
          await tileset.readyPromise;

          // Apply simple styling
          try {
            const cityStyle = new Cesium.Cesium3DTileStyle({
              color: {
                conditions: [
                  ["${surface} === 'wall'", "color('#f2f2f2')"],
                  ["${surface} === 'roof'", "color('#ff5c4d')"],
                  ["${surface} === 'bridge'", "color('#999999')"]
                ]
              }
            });
            tileset.style = cityStyle;
          } catch(e){ console.warn('Style apply failed', e); }

          viewer.zoomTo(tileset).otherwise((e)=>console.warn(e));
          setStatus('LoD2 Tileset geladen.');
        } catch (err) {
          console.error('Error loading tileset', err);
          setStatus('Fehler beim Laden des Tilesets (siehe Konsole).');
        }
      }

      loadTileset();

    })();
  </script>
</body>
</html>
